<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WealthFlow UG - Empowering Ugandan Investors</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --primary: #00ff9d;
            --secondary: #ffcc00;
            --accent: #0099ff;
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #f0f0f0;
            --success: #00cc66;
            --warning: #ff9900;
            --danger: #ff3333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--darker);
            color: var(--light);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--dark);
            border-bottom: 1px solid rgba(0, 255, 157, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .drawer-toggle {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .drawer-toggle:hover {
            background: rgba(0, 255, 157, 0.1);
        }

        .logo h1 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo span {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: var(--dark);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .notification-icon {
            position: relative;
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .notification-icon:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Side Drawer */
        .side-drawer {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: var(--dark);
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .side-drawer.open {
            left: 0;
        }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-header h3 {
            color: var(--primary);
        }

        .close-drawer {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .drawer-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .drawer-nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            color: var(--light);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .drawer-nav-item:hover, .drawer-nav-item.active {
            background: rgba(0, 255, 157, 0.1);
            color: var(--primary);
        }

        .drawer-nav-item i {
            width: 20px;
            text-align: center;
        }

        .drawer-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .drawer-overlay.open {
            display: block;
        }

        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background: var(--dark);
            z-index: 1000;
            transition: right 0.3s ease;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .notifications-panel.open {
            right: 0;
        }

        .notifications-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-header h3 {
            color: var(--primary);
        }

        .close-notifications {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .notifications-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item.unread {
            background: rgba(0, 255, 157, 0.05);
            border-left: 3px solid var(--primary);
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .notification-message {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .notification-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .notification-type {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            background: rgba(0, 153, 255, 0.2);
            color: var(--accent);
        }

        .notification-type.personal {
            background: rgba(0, 255, 157, 0.2);
            color: var(--primary);
        }

        .empty-notifications {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-notifications i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .notifications-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .notifications-overlay.open {
            display: block;
        }

        /* Team Section Styles */
        .team-section {
            background: var(--dark);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            max-width: 800px;
            margin: 0 auto;
        }

        .team-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .team-stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .team-stat-card h3 {
            color: var(--light);
            opacity: 0.8;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .team-stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .team-stat-card .bonus-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .team-members-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .team-member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .team-member-item:last-child {
            border-bottom: none;
        }

        .team-member-info h4 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .team-member-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .team-member-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            background: rgba(0, 204, 102, 0.2);
            color: var(--success);
        }

        .team-member-status.pending {
            background: rgba(255, 153, 0, 0.2);
            color: var(--warning);
        }

        .bonus-earnings {
            background: linear-gradient(135deg, var(--secondary), #e6b800);
            color: var(--dark);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .bonus-earnings h3 {
            color: var(--dark);
            margin-bottom: 10px;
        }

        .bonus-earnings .amount {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--dark);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(0, 255, 157, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--light);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .main-content {
            padding: 20px 0;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--dark);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .stat-card h3 {
            font-size: 1rem;
            color: var(--light);
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-card .icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            opacity: 0.2;
        }

        .invest-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .invest-card {
            background: var(--dark);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }

        .merchant-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid rgba(255, 204, 0, 0.2);
        }

        .merchant-id {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary);
            margin: 10px 0;
        }

        .transaction-history {
            background: var(--dark);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .deposit {
            color: var(--success);
        }

        .withdrawal {
            color: var(--danger);
        }

        .profit {
            color: var(--accent);
        }

        .bonus {
            color: var(--secondary);
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status.pending {
            background: rgba(255, 153, 0, 0.2);
            color: var(--warning);
        }

        .status.approved {
            background: rgba(0, 204, 102, 0.2);
            color: var(--success);
        }

        .profile-card {
            background: var(--dark);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px;
            font-size: 2.5rem;
            color: var(--dark);
        }

        .profile-info h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .profile-details {
            text-align: left;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .profile-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-detail-item:last-child {
            border-bottom: none;
        }

        .profile-detail-label {
            color: var(--light);
            opacity: 0.8;
        }

        .profile-detail-value {
            color: var(--primary);
            font-weight: 600;
        }

        .social-drawer {
            background: var(--dark);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            max-width: 500px;
            margin: 20px auto 0;
        }

        .social-drawer h3 {
            color: var(--secondary);
            margin-bottom: 20px;
            text-align: center;
        }

        .social-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .social-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .social-btn.facebook {
            color: #1877F2;
        }

        .social-btn.tiktok {
            color: #000000;
        }

        .social-btn.youtube {
            color: #FF0000;
        }

        .social-btn.twitter {
            color: #1DA1F2;
        }

        .social-btn.instagram {
            color: #E4405F;
        }

        .social-btn.telegram {
            color: #0088CC;
        }

        .social-btn.support {
            color: var(--primary);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--dark);
            border-top: 1px solid rgba(0, 255, 157, 0.2);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--light);
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .nav-item.active {
            color: var(--primary);
            opacity: 1;
        }

        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .quick-action {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--dark);
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 99;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: var(--light);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.warning {
            background: var(--warning);
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .wave-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .wave-bar {
            width: 10px;
            height: 30px;
            margin: 0 3px;
            background: linear-gradient(to top, var(--primary), var(--accent));
            border-radius: 10px;
            animation: wave 1.2s infinite ease-in-out;
        }

        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 40%, 100% { transform: scaleY(0.5); }
            20% { transform: scaleY(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--light);
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: var(--dark);
        }

        .profit-card {
            background: linear-gradient(135deg, var(--success), var(--accent));
            color: var(--dark);
        }

        .investment-card {
            background: linear-gradient(135deg, var(--warning), var(--secondary));
            color: var(--dark);
        }

        .deposit-card {
            background: linear-gradient(135deg, var(--accent), #6a11cb);
            color: var(--light);
        }

        .card-dark-text h3, .card-dark-text .value {
            color: var(--dark) !important;
        }

        .investment-details {
            margin-top: 10px;
            font-size: 0.9rem;
            text-align: left;
        }

        .investment-details p {
            margin: 5px 0;
        }

        .investment-plan {
            font-weight: bold;
            color: var(--dark);
        }

        .investment-amount {
            color: var(--dark);
        }

        .active-investments-section {
            margin-top: 30px;
            background: var(--dark);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            max-width: 500px;
            margin: 30px auto 0;
        }

        .active-investments-section h3 {
            color: var(--secondary);
            margin-bottom: 20px;
            text-align: center;
        }

        .investment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .investment-item:last-child {
            border-bottom: none;
        }

        .investment-info h4 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .investment-info p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .investment-amount {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--secondary);
        }

        /* Success Modal Styles */
        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .success-modal-content {
            background: var(--dark);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            border: 1px solid rgba(0, 255, 157, 0.2);
            text-align: center;
        }

        .success-icon {
            font-size: 4rem;
            color: var(--success);
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .success-message {
            color: var(--light);
            line-height: 1.6;
            margin-bottom: 25px;
        }

        /* Bonus Badge */
        .bonus-badge {
            display: inline-block;
            background: var(--secondary);
            color: var(--dark);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 5px;
            vertical-align: middle;
        }

        /* Referral System Styles */
        .referral-section {
            background: var(--dark);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            max-width: 500px;
            margin: 20px auto;
        }

        .referral-code-box {
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .referral-code {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
            margin: 10px 0;
            font-family: monospace;
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .referral-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .referral-stat h4 {
            color: var(--light);
            opacity: 0.8;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .referral-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .referral-link {
            display: flex;
            margin-bottom: 15px;
        }

        .referral-link input {
            flex: 1;
            border-radius: 5px 0 0 5px;
        }

        .referral-link button {
            border-radius: 0 5px 5px 0;
        }

        .referral-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .referral-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .referral-item:last-child {
            border-bottom: none;
        }

        .referral-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(0, 204, 102, 0.2);
            color: var(--success);
        }

        .referral-status.pending {
            background: rgba(255, 153, 0, 0.2);
            color: var(--warning);
        }

        /* Account Status Styles */
        .account-status-banner {
            background: linear-gradient(135deg, var(--warning), var(--danger));
            color: var(--light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        .account-status-banner.blocked {
            background: linear-gradient(135deg, var(--danger), #cc0000);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .account-status-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .disabled-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: var(--light);
            text-align: center;
            padding: 20px;
        }

        .disabled-overlay h2 {
            color: var(--danger);
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .disabled-overlay p {
            font-size: 1.2rem;
            margin-bottom: 10px;
            max-width: 500px;
        }

        .support-contact {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid var(--primary);
        }

        .support-contact a {
            color: var(--primary);
            text-decoration: none;
            font-weight: bold;
        }

        .support-contact a:hover {
            text-decoration: underline;
        }

        /* Hidden Chipper Link */
        .hidden-chipper-link {
            display: none;
        }

        /* Payment Flow Styles */
        .payment-flow {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .payment-step {
            background: var(--dark);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .step-title {
            font-weight: bold;
            color: var(--primary);
        }
        
        .step-content {
            margin-left: 40px;
        }
        
        .chipper-payment-info {
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .chipper-payment-info h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .payment-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .payment-actions .btn {
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- Account Status Overlay -->
    <div class="disabled-overlay" id="accountStatusOverlay" style="display: none;">
        <div class="account-status-icon">
            <i class="fas fa-ban"></i>
        </div>
        <h2 id="accountStatusTitle">Account Suspended</h2>
        <p id="accountStatusMessage">Your account has been temporarily suspended. Please contact support for more information.</p>
        <div class="support-contact">
            <p><strong>Contact Support:</strong></p>
            <p>Email: <a href="mailto:support@wealthflowug.com">support@wealthflowug.com</a></p>
            <p>Phone: <a href="tel:+256700000000">+256 700 000 000</a></p>
        </div>
        <button class="btn btn-primary" id="logoutFromSuspended" style="margin-top: 20px;">Logout</button>
    </div>

    <!-- Side Drawer -->
    <div class="side-drawer" id="sideDrawer">
        <div class="drawer-header">
            <h3>WealthFlow UG</h3>
            <button class="close-drawer" id="closeDrawer">×</button>
        </div>
        <div class="drawer-content">
            <a href="#" class="drawer-nav-item active" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="drawer-nav-item" data-section="invest">
                <i class="fas fa-chart-line"></i>
                <span>Invest</span>
            </a>
            <a href="#" class="drawer-nav-item" data-section="wallet">
                <i class="fas fa-wallet"></i>
                <span>Wallet</span>
            </a>
            <a href="#" class="drawer-nav-item" data-section="team">
                <i class="fas fa-users"></i>
                <span>Team</span>
            </a>
            <a href="#" class="drawer-nav-item" data-section="profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
            <a href="#" class="drawer-nav-item" id="drawerNotifications">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
                <span class="notification-badge" id="drawerNotificationBadge" style="display: none;">0</span>
            </a>
            <a href="#" class="drawer-nav-item" id="drawerSupport">
                <i class="fas fa-headset"></i>
                <span>Support</span>
            </a>
            <a href="#" class="drawer-nav-item" id="drawerAbout">
                <i class="fas fa-info-circle"></i>
                <span>About</span>
            </a>
            <a href="#" class="drawer-nav-item" id="drawerLogout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
        <div class="drawer-footer">
            <p>WealthFlow UG © 2023</p>
            <p>Empowering Ugandan Investors</p>
        </div>
    </div>
    <div class="drawer-overlay" id="drawerOverlay"></div>

    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <h3>Notifications</h3>
            <button class="close-notifications" id="closeNotifications">×</button>
        </div>
        <div class="notifications-content" id="notificationsContent">
            <div class="empty-notifications">
                <i class="fas fa-bell-slash"></i>
                <h3>No Notifications</h3>
                <p>You don't have any notifications yet</p>
            </div>
        </div>
    </div>
    <div class="notifications-overlay" id="notificationsOverlay"></div>

    <header>
        <div class="header-left">
            <button class="drawer-toggle" id="drawerToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <h1>WealthFlow UG <span>Empowering Ugandan Investors</span></h1>
            </div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationToggle">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
            <div class="auth-buttons">
                <button class="btn btn-secondary" id="loginBtn">Login</button>
                <button class="btn btn-primary" id="signupBtn">Sign Up</button>
            </div>
        </div>
    </header>

    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Login</h2>
                <button class="close-modal" id="closeModal">×</button>
            </div>
            <form id="authForm">
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" class="form-control" placeholder="0771234567" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <div class="form-group" id="nameGroup" style="display: none;">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" class="form-control">
                </div>
                <div class="form-group" id="emailGroup" style="display: none;">
                    <label for="email">Email (Optional)</label>
                    <input type="email" id="email" class="form-control">
                </div>
                <div class="form-group" id="referralGroup" style="display: none;">
                    <label for="referralCode">Referral Code (Optional)</label>
                    <input type="text" id="referralCode" class="form-control" placeholder="Enter referral code">
                    <div id="referralOwner" style="margin-top: 5px; font-size: 0.9rem; color: var(--primary); display: none;">
                        Referred by: <span id="referralOwnerName"></span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="authSubmit">Login</button>
                <div class="form-switch">
                    <p id="switchText">Don't have an account? <a id="switchAuth">Sign Up</a></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-modal-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="success-title">Success</h2>
            <p class="success-message" id="successMessage">
                Your payment request of the amount requested has been sent! Payment will be processed after successfully verification on time
            </p>
            <button class="btn btn-primary" id="closeSuccessModal">OK</button>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- Account Status Banner (shown when account is suspended) -->
            <div class="account-status-banner" id="suspendedBanner" style="display: none;">
                <div class="account-status-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3>Account Suspended</h3>
                <p id="suspensionReason">Your account has been temporarily suspended. Some features may be limited.</p>
                <p>Please contact support for more information.</p>
            </div>

            <div class="section active" id="dashboard">
                <h2 class="section-title">Dashboard</h2>
                <div class="stats-cards">
                    <div class="stat-card balance-card card-dark-text">
                        <h3>Total Balance</h3>
                        <div class="value" id="totalBalance">UGX 0</div>
                        <div class="icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div class="stat-card profit-card card-dark-text">
                        <h3>Total Profits</h3>
                        <div class="value" id="totalProfits">UGX 0</div>
                        <div class="icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-card investment-card card-dark-text">
                        <h3>Active Investments</h3>
                        <div class="value" id="activeInvestments">0</div>
                        <div class="icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="investment-details" id="investmentDetails">
                            <!-- Investment details will be displayed here -->
                        </div>
                    </div>
                    <div class="stat-card deposit-card">
                        <h3>Total Deposits</h3>
                        <div class="value" id="totalDeposits">UGX 0</div>
                        <div class="icon">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                    </div>
                </div>
                <div class="invest-options">
                    <div class="invest-card">
                        <h3>Beginner Plan</h3>
                        <p>Start with UGX 3,000 and earn 5% daily returns</p>
                        <button class="btn btn-primary invest-btn" data-plan="beginner" data-amount="3000">
                            <span class="btn-text">Invest Now</span>
                        </button>
                    </div>
                    <div class="invest-card">
                        <h3>Standard Plan</h3>
                        <p>Invest UGX 10,000+ for premium support</p>
                        <button class="btn btn-primary invest-btn" data-plan="standard" data-amount="10000">
                            <span class="btn-text">Invest Now</span>
                        </button>
                    </div>
                    <div class="invest-card">
                        <h3>Premium Plan</h3>
                        <p>UGX 50,000+ for serious investors</p>
                        <button class="btn btn-primary invest-btn" data-plan="premium" data-amount="50000">
                            <span class="btn-text">Invest Now</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="section" id="invest">
                <h2 class="section-title">Invest</h2>
                <div class="invest-card">
                    <h3>Make a Deposit</h3>
                    <p>Minimum deposit: UGX 3,000</p>
                    
                    <div class="payment-flow">
                        <div class="payment-step">
                            <div class="step-header">
                                <div class="step-number">1</div>
                                <div class="step-title">Enter Deposit Details</div>
                            </div>
                            <div class="step-content">
                                <div class="form-group">
                                    <label for="depositAmount">Amount (UGX)</label>
                                    <input type="number" id="depositAmount" class="form-control" min="3000" placeholder="3000">
                                </div>
                                <div class="form-group">
                                    <label for="depositPhone">Phone Number</label>
                                    <input type="tel" id="depositPhone" class="form-control" placeholder="0771234567">
                                </div>
                                <button class="btn btn-primary" id="depositBtn">
                                    <span class="btn-text">Deposit</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="payment-step" id="paymentStep2" style="display: none;">
                            <div class="step-header">
                                <div class="step-number">2</div>
                                <div class="step-title">Make Payment via Chipper Cash</div>
                            </div>
                            <div class="step-content">
                                <div class="chipper-payment-info">
                                    <h4>Payment Information</h4>
                                    <p><strong>Chipper Handle:</strong> @Lukwaho72</p>
                                    <p><strong>Amount to Send:</strong> <span id="chipperAmount">UGX 0</span></p>
                                    <p><strong>Reference:</strong> <span id="transactionReference">WF-</span></p>
                                    <p>Please include the reference in your payment</p>
                                </div>
                                <p>Click the button below to open Chipper Cash and complete your payment:</p>
                                <div class="payment-actions">
                                    <button class="btn btn-primary" id="openChipper">
                                        <span class="btn-text">Open Chipper Cash</span>
                                    </button>
                                    <button class="btn btn-secondary" id="paymentComplete">
                                        <span class="btn-text">I've Completed Payment</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-step" id="paymentStep3" style="display: none;">
                            <div class="step-header">
                                <div class="step-number">3</div>
                                <div class="step-title">Payment Submitted for Approval</div>
                            </div>
                            <div class="step-content">
                                <div class="success-icon" style="font-size: 3rem; color: var(--success); margin-bottom: 15px;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <p>Your payment request has been submitted to the admin for approval.</p>
                                <p>You will receive a notification once your deposit is approved and funds are added to your account.</p>
                                <button class="btn btn-primary" id="newDeposit">
                                    <span class="btn-text">Make Another Deposit</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section" id="wallet">
                <h2 class="section-title">Wallet</h2>
                <div class="transaction-history">
                    <h3>Transaction History</h3>
                    <div class="transaction-list" id="transactionList">
                        <div class="wave-loader" id="transactionLoader">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                    </div>
                </div>
                
                <div class="invest-card" style="margin-top: 30px;">
                    <h3>Request Withdrawal</h3>
                    <p>Minimum withdrawal: UGX 1,000</p>
                    <div class="form-group">
                        <label for="withdrawAmount">Amount (UGX)</label>
                        <input type="number" id="withdrawAmount" class="form-control" min="1000" placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number</label>
                        <input type="tel" id="phoneNumber" class="form-control" placeholder="0771234567">
                    </div>
                    <button class="btn btn-primary" id="submitWithdrawal">Request Withdrawal</button>
                </div>
            </div>

            <!-- Team Section -->
            <div class="section" id="team">
                <h2 class="section-title">My Team</h2>
                <div class="team-section">
                    <div class="team-stats">
                        <div class="team-stat-card">
                            <h3>Total Team Members</h3>
                            <div class="value" id="totalTeamMembers">0</div>
                        </div>
                        <div class="team-stat-card">
                            <h3>Active Members</h3>
                            <div class="value" id="activeTeamMembers">0</div>
                        </div>
                        <div class="team-stat-card">
                            <h3>Team Bonus Rate</h3>
                            <div class="value" id="teamBonusRate">0%</div>
                            <div class="bonus-info" id="bonusInfo">0+ members needed for 2% bonus</div>
                        </div>
                        <div class="team-stat-card">
                            <h3>Total Team Earnings</h3>
                            <div class="value" id="totalTeamEarnings">UGX 0</div>
                        </div>
                    </div>

                    <div class="bonus-earnings" id="bonusEarningsCard" style="display: none;">
                        <h3>🎉 Team Bonus Active! 🎉</h3>
                        <p>You're earning <strong id="currentBonusRate">2%</strong> from your team's investments</p>
                        <div class="amount" id="teamBonusAmount">UGX 0</div>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Updated daily based on team activity</p>
                    </div>

                    <h3 style="margin: 30px 0 20px 0; color: var(--primary);">Team Members</h3>
                    <div class="team-members-list" id="teamMembersList">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No Team Members Yet</h3>
                            <p>Share your referral code to build your team and start earning bonuses!</p>
                            <button class="btn btn-primary" onclick="switchSection('profile')">Get Referral Code</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section" id="profile">
                <h2 class="section-title">Profile</h2>
                <div class="profile-card">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-info">
                        <h2 id="userName">Guest User</h2>
                        <p id="userEmail">Not logged in</p>
                    </div>
                    
                    <div class="profile-details">
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Phone Number:</span>
                            <span class="profile-detail-value" id="profilePhone">Not available</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Email:</span>
                            <span class="profile-detail-value" id="profileEmail">Not available</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Account Status:</span>
                            <span class="profile-detail-value" id="profileStatus">Active</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Joined Date:</span>
                            <span class="profile-detail-value" id="profileJoinedDate">Not available</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Account Balance:</span>
                            <span class="profile-detail-value" id="profileBalance">UGX 0</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Total Profits:</span>
                            <span class="profile-detail-value" id="profileProfits">UGX 0</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Active Investments:</span>
                            <span class="profile-detail-value" id="profileInvestments">0</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Total Deposits:</span>
                            <span class="profile-detail-value" id="profileTotalDeposits">UGX 0</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Total Withdrawals:</span>
                            <span class="profile-detail-value" id="profileTotalWithdrawals">UGX 0</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">First Deposit Bonus:</span>
                            <span class="profile-detail-value" id="profileFirstDepositBonus">Not yet claimed</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Referral Code:</span>
                            <span class="profile-detail-value" id="profileReferralCode">Not available</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-detail-label">Referred By:</span>
                            <span class="profile-detail-value" id="profileReferredBy">No one</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" id="logoutBtn">Logout</button>
                </div>
                
                <!-- Referral Section -->
                <div class="referral-section">
                    <h3>Referral Program</h3>
                    <div class="referral-code-box">
                        <h4>Your Referral Code</h4>
                        <div class="referral-code" id="userReferralCode">Loading...</div>
                        <p>Share this code with friends to earn UGX 500 when they make their first deposit!</p>
                    </div>
                    
                    <div class="referral-stats">
                        <div class="referral-stat">
                            <h4>Total Referrals</h4>
                            <div class="value" id="totalReferralsCount">0</div>
                        </div>
                        <div class="referral-stat">
                            <h4>Earned Bonuses</h4>
                            <div class="value" id="totalReferralEarnings">UGX 0</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Your Referral Link</label>
                        <div class="referral-link">
                            <input type="text" id="referralLink" class="form-control" readonly>
                            <button class="btn btn-primary" id="copyReferralLink">Copy</button>
                        </div>
                    </div>
                    
                    <h4>Your Referrals</h4>
                    <div class="referral-list" id="referralList">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No Referrals Yet</h3>
                            <p>Share your referral code to start earning!</p>
                        </div>
                    </div>
                </div>
                
                <div class="active-investments-section" id="profileInvestmentsSection">
                    <h3>Active Investments</h3>
                    <div class="investments-list" id="profileInvestmentsList">
                        <div class="empty-state">
                            <i class="fas fa-chart-pie"></i>
                            <h3>No Active Investments</h3>
                            <p>Start investing to see your active investments here</p>
                            <button class="btn btn-primary" onclick="switchSection('invest')">Start Investing</button>
                        </div>
                    </div>
                </div>
                
                <div class="social-drawer">
                    <h3>Follow Us & Get Support</h3>
                    <div class="social-buttons">
                        <button class="social-btn facebook" id="facebookBtn">
                            <i class="fab fa-facebook"></i>
                            <span>Facebook</span>
                        </button>
                        <button class="social-btn tiktok" id="tiktokBtn">
                            <i class="fab fa-tiktok"></i>
                            <span>TikTok</span>
                        </button>
                        <button class="social-btn youtube" id="youtubeBtn">
                            <i class="fab fa-youtube"></i>
                            <span>YouTube</span>
                        </button>
                        <button class="social-btn twitter" id="twitterBtn">
                            <i class="fab fa-twitter"></i>
                            <span>Twitter</span>
                        </button>
                        <button class="social-btn instagram" id="instagramBtn">
                            <i class="fab fa-instagram"></i>
                            <span>Instagram</span>
                        </button>
                        <button class="social-btn telegram" id="telegramBtn">
                            <i class="fab fa-telegram"></i>
                            <span>Telegram</span>
                        </button>
                        <button class="social-btn support" id="supportBtn">
                            <i class="fas fa-envelope"></i>
                            <span>Support</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" data-section="dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </div>
        <div class="nav-item" data-section="invest">
            <i class="fas fa-chart-line"></i>
            <span>Invest</span>
        </div>
        <div class="nav-item" data-section="wallet">
            <i class="fas fa-wallet"></i>
            <span>Wallet</span>
        </div>
        <div class="nav-item" data-section="team">
            <i class="fas fa-users"></i>
            <span>Team</span>
        </div>
        <div class="nav-item" data-section="profile">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
    </div>

    <div class="quick-action" id="quickDeposit">
        <i class="fas fa-plus"></i>
    </div>

    <div class="toast" id="toast"></div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing...</p>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAb7jPxLUOHsfyQAO3r0pO2aK7y6jZEE28",
            authDomain: "ericix-elite.firebaseapp.com",
            databaseURL: "https://ericix-elite-default-rtdb.firebaseio.com",
            projectId: "ericix-elite",
            storageBucket: "ericix-elite.firebasestorage.app",
            messagingSenderId: "991442688268",
            appId: "1:991442688268:web:a85badb64d61cee8f31129",
            measurementId: "G-MWCW52Z8D4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let userData = null;
        let currentDepositAmount = 0;
        let currentDepositPhone = '';
        let currentTransactionRef = '';

        // DOM Elements
        const elements = {
            authModal: document.getElementById('authModal'),
            successModal: document.getElementById('successModal'),
            successMessage: document.getElementById('successMessage'),
            closeSuccessModal: document.getElementById('closeSuccessModal'),
            loginBtn: document.getElementById('loginBtn'),
            signupBtn: document.getElementById('signupBtn'),
            closeModal: document.getElementById('closeModal'),
            authForm: document.getElementById('authForm'),
            modalTitle: document.getElementById('modalTitle'),
            nameGroup: document.getElementById('nameGroup'),
            emailGroup: document.getElementById('emailGroup'),
            referralGroup: document.getElementById('referralGroup'),
            referralOwner: document.getElementById('referralOwner'),
            referralOwnerName: document.getElementById('referralOwnerName'),
            authSubmit: document.getElementById('authSubmit'),
            switchAuth: document.getElementById('switchAuth'),
            switchText: document.getElementById('switchText'),
            navItems: document.querySelectorAll('.nav-item'),
            sections: document.querySelectorAll('.section'),
            quickDeposit: document.getElementById('quickDeposit'),
            toast: document.getElementById('toast'),
            loading: document.getElementById('loading'),
            submitWithdrawal: document.getElementById('submitWithdrawal'),
            logoutBtn: document.getElementById('logoutBtn'),
            facebookBtn: document.getElementById('facebookBtn'),
            tiktokBtn: document.getElementById('tiktokBtn'),
            youtubeBtn: document.getElementById('youtubeBtn'),
            twitterBtn: document.getElementById('twitterBtn'),
            instagramBtn: document.getElementById('instagramBtn'),
            telegramBtn: document.getElementById('telegramBtn'),
            supportBtn: document.getElementById('supportBtn'),
            transactionList: document.getElementById('transactionList'),
            transactionLoader: document.getElementById('transactionLoader'),
            investmentDetails: document.getElementById('investmentDetails'),
            profileInvestmentsList: document.getElementById('profileInvestmentsList'),
            userReferralCode: document.getElementById('userReferralCode'),
            totalReferralsCount: document.getElementById('totalReferralsCount'),
            totalReferralEarnings: document.getElementById('totalReferralEarnings'),
            referralLink: document.getElementById('referralLink'),
            copyReferralLink: document.getElementById('copyReferralLink'),
            referralList: document.getElementById('referralList'),
            referralCode: document.getElementById('referralCode'),
            accountStatusOverlay: document.getElementById('accountStatusOverlay'),
            accountStatusTitle: document.getElementById('accountStatusTitle'),
            accountStatusMessage: document.getElementById('accountStatusMessage'),
            logoutFromSuspended: document.getElementById('logoutFromSuspended'),
            suspendedBanner: document.getElementById('suspendedBanner'),
            suspensionReason: document.getElementById('suspensionReason'),
            // New elements for drawer and notifications
            drawerToggle: document.getElementById('drawerToggle'),
            sideDrawer: document.getElementById('sideDrawer'),
            closeDrawer: document.getElementById('closeDrawer'),
            drawerOverlay: document.getElementById('drawerOverlay'),
            drawerNavItems: document.querySelectorAll('.drawer-nav-item'),
            drawerNotifications: document.getElementById('drawerNotifications'),
            drawerNotificationBadge: document.getElementById('drawerNotificationBadge'),
            drawerSupport: document.getElementById('drawerSupport'),
            drawerAbout: document.getElementById('drawerAbout'),
            drawerLogout: document.getElementById('drawerLogout'),
            notificationToggle: document.getElementById('notificationToggle'),
            notificationBadge: document.getElementById('notificationBadge'),
            notificationsPanel: document.getElementById('notificationsPanel'),
            closeNotifications: document.getElementById('closeNotifications'),
            notificationsOverlay: document.getElementById('notificationsOverlay'),
            notificationsContent: document.getElementById('notificationsContent'),
            // Team section elements
            totalTeamMembers: document.getElementById('totalTeamMembers'),
            activeTeamMembers: document.getElementById('activeTeamMembers'),
            teamBonusRate: document.getElementById('teamBonusRate'),
            bonusInfo: document.getElementById('bonusInfo'),
            totalTeamEarnings: document.getElementById('totalTeamEarnings'),
            bonusEarningsCard: document.getElementById('bonusEarningsCard'),
            currentBonusRate: document.getElementById('currentBonusRate'),
            teamBonusAmount: document.getElementById('teamBonusAmount'),
            teamMembersList: document.getElementById('teamMembersList'),
            // Invest buttons
            investButtons: document.querySelectorAll('.invest-btn'),
            // Payment flow elements
            depositBtn: document.getElementById('depositBtn'),
            paymentStep2: document.getElementById('paymentStep2'),
            paymentStep3: document.getElementById('paymentStep3'),
            chipperAmount: document.getElementById('chipperAmount'),
            transactionReference: document.getElementById('transactionReference'),
            openChipper: document.getElementById('openChipper'),
            paymentComplete: document.getElementById('paymentComplete'),
            newDeposit: document.getElementById('newDeposit'),
            depositAmount: document.getElementById('depositAmount'),
            depositPhone: document.getElementById('depositPhone')
        };

        // Event Listeners
        elements.loginBtn.addEventListener('click', () => showAuthModal(true));
        elements.signupBtn.addEventListener('click', () => showAuthModal(false));
        elements.closeModal.addEventListener('click', hideAuthModal);
        elements.closeSuccessModal.addEventListener('click', hideSuccessModal);
        elements.switchAuth.addEventListener('click', toggleAuthMode);
        elements.authForm.addEventListener('submit', handleAuth);
        elements.quickDeposit.addEventListener('click', () => switchSection('invest'));
        elements.submitWithdrawal.addEventListener('click', submitWithdrawal);
        elements.logoutBtn.addEventListener('click', handleLogout);
        elements.copyReferralLink.addEventListener('click', copyReferralLink);
        elements.logoutFromSuspended.addEventListener('click', handleLogout);
        
        // Social media buttons
        elements.facebookBtn.addEventListener('click', () => openSocialLink('https://facebook.com/wealthflowug'));
        elements.tiktokBtn.addEventListener('click', () => openSocialLink('https://tiktok.com/@wealthflowug'));
        elements.youtubeBtn.addEventListener('click', () => openSocialLink('https://youtube.com/wealthflowug'));
        elements.twitterBtn.addEventListener('click', () => openSocialLink('https://twitter.com/wealthflowug'));
        elements.instagramBtn.addEventListener('click', () => openSocialLink('https://instagram.com/wealthflowug'));
        elements.telegramBtn.addEventListener('click', () => openSocialLink('https://t.me/wealthflowug'));
        elements.supportBtn.addEventListener('click', () => window.location.href = 'mailto:support@wealthflowug.com');

        // Invest buttons
        elements.investButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (!currentUser) {
                    showToast('Please log in first', 'warning');
                    return;
                }
                const amount = parseInt(button.dataset.amount);
                const plan = button.dataset.plan;
                createInvestment(amount, plan);
            });
        });

        // Referral code input listener
        elements.referralCode.addEventListener('input', checkReferralCode);

        // Drawer and notifications listeners
        elements.drawerToggle.addEventListener('click', openDrawer);
        elements.closeDrawer.addEventListener('click', closeDrawer);
        elements.drawerOverlay.addEventListener('click', closeDrawer);
        elements.notificationToggle.addEventListener('click', openNotifications);
        elements.closeNotifications.addEventListener('click', closeNotifications);
        elements.notificationsOverlay.addEventListener('click', closeNotifications);
        
        // Drawer navigation items
        elements.drawerNavItems.forEach(item => {
            if (item.dataset.section) {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchSection(item.dataset.section);
                    closeDrawer();
                });
            }
        });
        
        elements.drawerNotifications.addEventListener('click', (e) => {
            e.preventDefault();
            openNotifications();
            closeDrawer();
        });
        
        elements.drawerSupport.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = 'mailto:support@wealthflowug.com';
            closeDrawer();
        });
        
        elements.drawerAbout.addEventListener('click', (e) => {
            e.preventDefault();
            showToast('WealthFlow UG - Empowering Ugandan Investors', 'info');
            closeDrawer();
        });
        
        elements.drawerLogout.addEventListener('click', (e) => {
            e.preventDefault();
            handleLogout();
            closeDrawer();
        });

        elements.navItems.forEach(item => {
            item.addEventListener('click', () => switchSection(item.dataset.section));
        });

        // New event listeners for deposit flow
        elements.depositBtn.addEventListener('click', processDeposit);
        elements.openChipper.addEventListener('click', openChipperPayment);
        elements.paymentComplete.addEventListener('click', completePayment);
        elements.newDeposit.addEventListener('click', resetDepositForm);

        // Auth State Listener
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                // Check user status before setting up listeners
                checkUserStatus(user.uid).then(status => {
                    if (status === 'active') {
                        setupRealtimeListeners();
                        showToast('Welcome to WealthFlow UG!', 'success');
                    } else {
                        // User is suspended or blocked, show appropriate message
                        handleSuspendedOrBlockedUser(status);
                    }
                });
            } else {
                cleanupListeners();
                hideAccountStatusMessages();
            }
            updateUI();
        });

        // Functions for deposit flow
        async function processDeposit() {
            if (!currentUser) {
                showToast('Please log in first', 'warning');
                return;
            }
            
            // Get deposit details
            const amount = parseInt(elements.depositAmount.value);
            const phone = elements.depositPhone.value;
            
            // Validate inputs
            if (!amount || amount < 3000) {
                showToast('Please enter a valid deposit amount (minimum UGX 3,000)', 'warning');
                return;
            }
            
            if (!phone) {
                showToast('Please enter your phone number', 'warning');
                return;
            }
            
            showLoading(true);
            
            try {
                // Generate a unique transaction reference
                const transactionRef = 'WF-' + Date.now() + '-' + Math.random().toString(36).substring(2, 8).toUpperCase();
                
                // Save deposit request to Firestore
                await db.collection('depositRequests').add({
                    userId: currentUser.uid,
                    userName: userData.name,
                    amount: amount,
                    phone: phone,
                    transactionRef: transactionRef,
                    status: 'pending_payment',
                    createdAt: new Date().toISOString()
                });
                
                // Create a transaction record
                await db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'deposit',
                    amount: amount,
                    phone: phone,
                    transactionRef: transactionRef,
                    status: 'pending',
                    paymentMethod: 'Chipper',
                    createdAt: new Date().toISOString()
                });
                
                // Create a notification for the admin
                await db.collection('notifications').add({
                    title: 'New Deposit Request',
                    message: `${userData.name} has submitted a deposit request of UGX ${amount} (Ref: ${transactionRef})`,
                    type: 'deposit',
                    targetUsers: ['admin'],
                    createdAt: new Date().toISOString()
                });
                
                // Store current deposit details for the next steps
                currentDepositAmount = amount;
                currentDepositPhone = phone;
                currentTransactionRef = transactionRef;
                
                // Update UI for step 2
                elements.chipperAmount.textContent = `UGX ${amount}`;
                elements.transactionReference.textContent = transactionRef;
                elements.paymentStep2.style.display = 'block';
                
                // Scroll to step 2
                elements.paymentStep2.scrollIntoView({ behavior: 'smooth' });
                
                // Automatically open Chipper Cash
                openChipperPayment();
                
                showToast('Deposit request submitted successfully! Opening Chipper Cash...', 'success');
            } catch (error) {
                console.error('Error processing deposit:', error);
                showToast('Error processing deposit request', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function openChipperPayment() {
            // Open Chipper Cash in a new tab
            window.open('https://chipper.me/@Lukwaho72', '_blank');
            
            // Show reminder about including the reference
            showToast('Please remember to include the transaction reference in your payment: ' + currentTransactionRef, 'info');
        }
        
        async function completePayment() {
            if (!currentUser) {
                showToast('Please log in first', 'warning');
                return;
            }
            
            showLoading(true);
            
            try {
                // Update deposit request status to "pending_approval"
                const depositRequestsSnapshot = await db.collection('depositRequests')
                    .where('transactionRef', '==', currentTransactionRef)
                    .get();
                
                if (!depositRequestsSnapshot.empty) {
                    depositRequestsSnapshot.forEach(async (doc) => {
                        await db.collection('depositRequests').doc(doc.id).update({
                            status: 'pending_approval',
                            paymentSubmittedAt: new Date().toISOString()
                        });
                    });
                }
                
                // Update transaction status
                const transactionsSnapshot = await db.collection('transactions')
                    .where('transactionRef', '==', currentTransactionRef)
                    .get();
                
                if (!transactionsSnapshot.empty) {
                    transactionsSnapshot.forEach(async (doc) => {
                        await db.collection('transactions').doc(doc.id).update({
                            status: 'pending_approval'
                        });
                    });
                }
                
                // Update UI for step 3
                elements.paymentStep3.style.display = 'block';
                elements.paymentStep2.style.display = 'none';
                
                // Scroll to step 3
                elements.paymentStep3.scrollIntoView({ behavior: 'smooth' });
                
                showToast('Payment details submitted successfully! Awaiting admin approval.', 'success');
            } catch (error) {
                console.error('Error completing payment:', error);
                showToast('Error completing payment', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function resetDepositForm() {
            // Reset form and show step 1 again
            elements.depositAmount.value = '';
            elements.depositPhone.value = '';
            elements.paymentStep3.style.display = 'none';
            elements.paymentStep2.style.display = 'none';
            
            // Reset current values
            currentDepositAmount = 0;
            currentDepositPhone = '';
            currentTransactionRef = '';
            
            showToast('Ready to make a new deposit', 'info');
        }

        // Function to check user status
        async function checkUserStatus(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    return userData.status || 'active';
                }
                return 'active'; // Default to active if no status found
            } catch (error) {
                console.error('Error checking user status:', error);
                return 'active'; // Default to active on error
            }
        }

        // Function to handle suspended or blocked users
        function handleSuspendedOrBlockedUser(status) {
            if (status === 'suspended') {
                showSuspendedBanner();
                disableUserActions();
                showToast('Your account has been suspended. Please contact support.', 'warning');
            } else if (status === 'blocked') {
                showBlockedOverlay();
                disableUserActions();
            }
        }

        // Function to show suspended banner
        function showSuspendedBanner() {
            elements.suspendedBanner.style.display = 'block';
            
            // Try to get suspension reason
            if (userData && userData.suspensionReason) {
                elements.suspensionReason.textContent = userData.suspensionReason;
            }
        }

        // Function to show blocked overlay
        function showBlockedOverlay() {
            elements.accountStatusOverlay.style.display = 'flex';
            elements.accountStatusTitle.textContent = 'Account Blocked';
            elements.accountStatusMessage.textContent = 'Your account has been permanently blocked. Please contact support for more information.';
            elements.accountStatusOverlay.classList.add('blocked');
        }

        // Function to hide all account status messages
        function hideAccountStatusMessages() {
            elements.suspendedBanner.style.display = 'none';
            elements.accountStatusOverlay.style.display = 'none';
            elements.accountStatusOverlay.classList.remove('blocked');
        }

        // Function to disable user actions
        function disableUserActions() {
            // Disable all action buttons
            const actionButtons = document.querySelectorAll('.btn:not(#logoutBtn):not(#logoutFromSuspended)');
            actionButtons.forEach(button => {
                button.disabled = true;
            });
            
            // Disable navigation
            elements.navItems.forEach(item => {
                item.style.pointerEvents = 'none';
                item.style.opacity = '0.5';
            });
            
            // Disable quick action
            elements.quickDeposit.style.pointerEvents = 'none';
            elements.quickDeposit.style.opacity = '0.5';
        }

        // Function to enable user actions
        function enableUserActions() {
            // Enable all action buttons
            const actionButtons = document.querySelectorAll('.btn:not(#logoutBtn):not(#logoutFromSuspended)');
            actionButtons.forEach(button => {
                button.disabled = false;
            });
            
            // Enable navigation
            elements.navItems.forEach(item => {
                item.style.pointerEvents = 'auto';
                item.style.opacity = '1';
            });
            
            // Enable quick action
            elements.quickDeposit.style.pointerEvents = 'auto';
            elements.quickDeposit.style.opacity = '1';
        }

        // Functions for drawer and notifications
        function openDrawer() {
            elements.sideDrawer.classList.add('open');
            elements.drawerOverlay.classList.add('open');
        }

        function closeDrawer() {
            elements.sideDrawer.classList.remove('open');
            elements.drawerOverlay.classList.remove('open');
        }

        function openNotifications() {
            if (!currentUser) {
                showToast('Please log in to view notifications', 'warning');
                return;
            }
            elements.notificationsPanel.classList.add('open');
            elements.notificationsOverlay.classList.add('open');
            markNotificationsAsRead();
        }

        function closeNotifications() {
            elements.notificationsPanel.classList.remove('open');
            elements.notificationsOverlay.classList.remove('open');
        }

        function showAuthModal(loginMode) {
            isLoginMode = loginMode;
            updateAuthMode();
            elements.authModal.style.display = 'flex';
        }

        function hideAuthModal() {
            elements.authModal.style.display = 'none';
        }

        function showSuccessModal(amount) {
            // Update the success message with the specific amount
            elements.successMessage.innerHTML = `Your payment request of <strong>UGX ${amount}</strong> has been sent! Payment will be processed after successfully verification on time`;
            elements.successModal.style.display = 'flex';
        }

        function hideSuccessModal() {
            elements.successModal.style.display = 'none';
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            updateAuthMode();
        }

        function updateAuthMode() {
            if (isLoginMode) {
                elements.modalTitle.textContent = 'Login';
                elements.authSubmit.textContent = 'Login';
                elements.switchText.innerHTML = 'Don\'t have an account? <a id="switchAuth">Sign Up</a>';
                elements.nameGroup.style.display = 'none';
                elements.emailGroup.style.display = 'none';
                elements.referralGroup.style.display = 'none';
            } else {
                elements.modalTitle.textContent = 'Sign Up';
                elements.authSubmit.textContent = 'Sign Up';
                elements.switchText.innerHTML = 'Already have an account? <a id="switchAuth">Login</a>';
                elements.nameGroup.style.display = 'block';
                elements.emailGroup.style.display = 'block';
                elements.referralGroup.style.display = 'block';
            }
        }

        // Function to generate referral codes
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Check if referral code is valid and show owner name
        async function checkReferralCode() {
            const code = elements.referralCode.value.trim().toUpperCase();
            
            if (code.length === 0) {
                elements.referralOwner.style.display = 'none';
                return;
            }
            
            if (code.length < 6) {
                return; // Wait for user to finish typing
            }
            
            try {
                const usersSnapshot = await db.collection('users').where('referralCode', '==', code).get();
                
                if (usersSnapshot.empty) {
                    elements.referralOwner.style.display = 'none';
                    showToast('Invalid referral code', 'warning');
                } else {
                    usersSnapshot.forEach(doc => {
                        const user = doc.data();
                        elements.referralOwnerName.textContent = user.name;
                        elements.referralOwner.style.display = 'block';
                        showToast(`Valid referral code! You'll be referred by ${user.name}`, 'success');
                    });
                }
            } catch (error) {
                console.error('Error checking referral code:', error);
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const referralCode = document.getElementById('referralCode').value.trim().toUpperCase();

            showLoading(true);

            try {
                if (isLoginMode) {
                    // Find user by phone number in Firestore
                    const usersSnapshot = await db.collection('users').where('phone', '==', phone).get();
                    
                    if (usersSnapshot.empty) {
                        throw new Error('No account found with this phone number');
                    }
                    
                    let userEmail = '';
                    let userStatus = 'active';
                    usersSnapshot.forEach(doc => {
                        userEmail = doc.data().email;
                        userStatus = doc.data().status || 'active';
                    });
                    
                    if (!userEmail) {
                        throw new Error('Account data error. Please contact support.');
                    }

                    // Check if user is suspended or blocked
                    if (userStatus === 'suspended') {
                        throw new Error('Your account has been suspended. Please contact support.');
                    } else if (userStatus === 'blocked') {
                        throw new Error('Your account has been blocked. Please contact support.');
                    }
                    
                    // Login with email (derived from phone)
                    await auth.signInWithEmailAndPassword(userEmail, password);
                } else {
                    if (!name) throw new Error('Please enter your full name');
                    if (!phone) throw new Error('Please enter your phone number');
                    
                    // Check if phone number is already registered
                    const usersSnapshot = await db.collection('users').where('phone', '==', phone).get();
                    
                    if (!usersSnapshot.empty) {
                        throw new Error('Phone number is already registered');
                    }
                    
                    // Create email from phone number for Firebase Auth
                    const userEmail = email || `${phone}@wealthflowug.com`;
                    
                    const userCredential = await auth.createUserWithEmailAndPassword(userEmail, password);
                    const userId = userCredential.user.uid;
                    
                    // Generate a unique referral code for the new user
                    let userReferralCode = generateReferralCode();
                    let codeExists = true;
                    
                    // Ensure the referral code is unique
                    while (codeExists) {
                        const checkCode = await db.collection('users').where('referralCode', '==', userReferralCode).get();
                        if (checkCode.empty) {
                            codeExists = false;
                        } else {
                            userReferralCode = generateReferralCode();
                        }
                    }
                    
                    const userData = {
                        name: name,
                        phone: phone,
                        email: userEmail,
                        password: password, // Store password for admin viewing
                        balance: 0,
                        totalDeposits: 0,
                        totalProfits: 0,
                        totalWithdrawals: 0,
                        activeInvestments: 0,
                        firstDepositBonus: false,
                        referralCode: userReferralCode,
                        referralCount: 0,
                        referralEarnings: 0,
                        teamEarnings: 0,
                        teamMembers: 0,
                        teamBonusRate: 0,
                        status: 'active',
                        joinedDate: new Date().toISOString()
                    };
                    
                    // If referral code was provided, validate it and set referredBy
                    if (referralCode) {
                        const referrerSnapshot = await db.collection('users').where('referralCode', '==', referralCode).get();
                        
                        if (!referrerSnapshot.empty) {
                            referrerSnapshot.forEach(doc => {
                                userData.referredBy = doc.id;
                                userData.referredByCode = referralCode;
                                userData.referredByName = doc.data().name; // Store referrer's name
                            });
                            
                            // Update referrer's referral count
                            if (userData.referredBy) {
                                await db.collection('users').doc(userData.referredBy).update({
                                    referralCount: firebase.firestore.FieldValue.increment(1),
                                    teamMembers: firebase.firestore.FieldValue.increment(1)
                                });
                            }
                        } else {
                            showToast('Invalid referral code. Please check and try again.', 'warning');
                            showLoading(false);
                            return;
                        }
                    }
                    
                    await db.collection('users').doc(userId).set(userData);
                    
                    // Show success message with referral info if applicable
                    if (referralCode) {
                        showToast(`Account created successfully! You were referred by ${userData.referredByName}`, 'success');
                    } else {
                        showToast('Account created successfully!', 'success');
                    }
                }
                hideAuthModal();
                elements.authForm.reset();
            } catch (error) {
                // Handle specific Firebase auth errors
                let errorMessage = error.message;
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Account not found. Please check your phone number or sign up for a new account.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid phone number format. Please check your phone number.';
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This phone number is already registered. Please log in instead.';
                }
                
                showToast(errorMessage, 'error');
            } finally {
                showLoading(false);
            }
        }

        function switchSection(sectionId) {
            elements.sections.forEach(section => section.classList.remove('active'));
            elements.navItems.forEach(nav => nav.classList.remove('active'));
            elements.drawerNavItems.forEach(nav => nav.classList.remove('active'));

            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            document.querySelector(`.drawer-nav-item[data-section="${sectionId}"]`).classList.add('active');

            // Show loading for wallet section
            if (sectionId === 'wallet' && currentUser) {
                showTransactionLoading();
                // Simulate loading delay for demo purposes
                setTimeout(() => {
                    loadTransactions();
                }, 1500);
            }
            
            // Load active investments when profile section is opened
            if (sectionId === 'profile' && currentUser) {
                loadProfileInvestments();
                loadReferralData();
            }
            
            // Load team data when team section is opened
            if (sectionId === 'team' && currentUser) {
                loadTeamData();
            }
        }

        // REAL-TIME LISTENERS - This fixes the sync issue
        function setupRealtimeListeners() {
            if (!currentUser) return;

            // User data real-time listener - updates balance immediately when admin approves
            userListener = db.collection('users').doc(currentUser.uid)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        
                        // Check if user status has changed
                        if (userData.status === 'suspended' || userData.status === 'blocked') {
                            handleSuspendedOrBlockedUser(userData.status);
                        } else {
                            hideAccountStatusMessages();
                            enableUserActions();
                            updateUserUI();
                        }
                    }
                }, (error) => {
                    console.error('User listener error:', error);
                });

            // Transactions real-time listener - updates transaction list immediately
            transactionsListener = db.collection('transactions')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    loadTransactions();
                }, (error) => {
                    console.error('Transactions listener error:', error);
                });

            // Investments real-time listener - updates active investments immediately
            investmentsListener = db.collection('investments')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'active')
                .onSnapshot((snapshot) => {
                    loadActiveInvestments(snapshot);
                    loadProfileInvestments();
                }, (error) => {
                    console.error('Investments listener error:', error);
                });

            // Referrals real-time listener - updates referral data immediately
            referralsListener = db.collection('referrals')
                .where('referrerId', '==', currentUser.uid)
                .orderBy('referralDate', 'desc')
                .onSnapshot((snapshot) => {
                    loadReferralData();
                }, (error) => {
                    console.error('Referrals listener error:', error);
                });

            // Notifications real-time listener
            notificationsListener = db.collection('notifications')
                .where('targetUsers', 'array-contains', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    loadNotifications(snapshot);
                }, (error) => {
                    console.error('Notifications listener error:', error);
                });

            // Team members real-time listener
            teamMembersListener = db.collection('users')
                .where('referredBy', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    loadTeamData();
                }, (error) => {
                    console.error('Team members listener error:', error);
                });
        }

        function cleanupListeners() {
            if (userListener) {
                userListener();
                userListener = null;
            }
            if (transactionsListener) {
                transactionsListener();
                transactionsListener = null;
            }
            if (investmentsListener) {
                investmentsListener();
                investmentsListener = null;
            }
            if (referralsListener) {
                referralsListener();
                referralsListener = null;
            }
            if (notificationsListener) {
                notificationsListener();
                notificationsListener = null;
            }
            if (teamMembersListener) {
                teamMembersListener();
                teamMembersListener = null;
            }
        }

        // Load and display notifications
        function loadNotifications(snapshot) {
            if (!currentUser) return;

            let unreadCount = 0;
            elements.notificationsContent.innerHTML = '';

            if (snapshot.empty) {
                elements.notificationsContent.innerHTML = `
                    <div class="empty-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No Notifications</h3>
                        <p>You don't have any notifications yet</p>
                    </div>
                `;
                updateNotificationBadges(0);
                return;
            }

            snapshot.forEach(doc => {
                const notification = doc.data();
                const isRead = notification.readBy && notification.readBy.includes(currentUser.uid);
                
                if (!isRead) unreadCount++;
                
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${isRead ? '' : 'unread'}`;
                notificationItem.dataset.id = doc.id;
                
                const typeClass = notification.type === 'personal' ? 'personal' : '';
                
                notificationItem.innerHTML = `
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-meta">
                        <span>${new Date(notification.createdAt.toDate()).toLocaleDateString()}</span>
                        <span class="notification-type ${typeClass}">${notification.type}</span>
                    </div>
                `;
                
                notificationItem.addEventListener('click', () => {
                    markNotificationAsRead(doc.id);
                });
                
                elements.notificationsContent.appendChild(notificationItem);
            });
            
            updateNotificationBadges(unreadCount);
        }

        // Update notification badges
        function updateNotificationBadges(count) {
            if (count > 0) {
                elements.notificationBadge.textContent = count > 99 ? '99+' : count;
                elements.notificationBadge.style.display = 'flex';
                elements.drawerNotificationBadge.textContent = count > 99 ? '99+' : count;
                elements.drawerNotificationBadge.style.display = 'flex';
            } else {
                elements.notificationBadge.style.display = 'none';
                elements.drawerNotificationBadge.style.display = 'none';
            }
        }

        // Mark a notification as read
        async function markNotificationAsRead(notificationId) {
            try {
                await db.collection('notifications').doc(notificationId).update({
                    readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Mark all notifications as read
        async function markNotificationsAsRead() {
            try {
                const snapshot = await db.collection('notifications')
                    .where('targetUsers', 'array-contains', currentUser.uid)
                    .get();
                
                const batch = db.batch();
                
                snapshot.forEach(doc => {
                    const notification = doc.data();
                    if (!notification.readBy || !notification.readBy.includes(currentUser.uid)) {
                        batch.update(doc.ref, {
                            readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                        });
                    }
                });
                
                await batch.commit();
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        // Load team data
        async function loadTeamData() {
            if (!currentUser) return;

            try {
                // Get all users referred by current user
                const teamSnapshot = await db.collection('users')
                    .where('referredBy', '==', currentUser.uid)
                    .get();

                const teamMembers = [];
                let activeMembers = 0;

                teamSnapshot.forEach(doc => {
                    const member = doc.data();
                    teamMembers.push({
                        id: doc.id,
                        name: member.name,
                        email: member.email,
                        phone: member.phone,
                        status: member.status,
                        joinedDate: member.joinedDate,
                        totalDeposits: member.totalDeposits || 0,
                        totalProfits: member.totalProfits || 0
                    });

                    if (member.status === 'active') {
                        activeMembers++;
                    }
                });

                // Calculate team bonus rate (2% for 20+ members)
                const teamBonusRate = teamMembers.length >= 20 ? 2 : 0;
                const teamEarnings = userData ? userData.teamEarnings || 0 : 0;

                // Update UI
                elements.totalTeamMembers.textContent = teamMembers.length;
                elements.activeTeamMembers.textContent = activeMembers;
                elements.teamBonusRate.textContent = `${teamBonusRate}%`;
                elements.totalTeamEarnings.textContent = `UGX ${teamEarnings}`;

                // Update bonus info
                if (teamMembers.length >= 20) {
                    elements.bonusInfo.textContent = '✓ 2% bonus active!';
                    elements.bonusInfo.style.color = 'var(--success)';
                    elements.bonusEarningsCard.style.display = 'block';
                    elements.currentBonusRate.textContent = '2%';
                    elements.teamBonusAmount.textContent = `UGX ${teamEarnings}`;
                } else {
                    const membersNeeded = 20 - teamMembers.length;
                    elements.bonusInfo.textContent = `${membersNeeded}+ members needed for 2% bonus`;
                    elements.bonusInfo.style.color = 'var(--warning)';
                    elements.bonusEarningsCard.style.display = 'none';
                }

                // Update user document with team stats
                if (userData) {
                    await db.collection('users').doc(currentUser.uid).update({
                        teamMembers: teamMembers.length,
                        teamBonusRate: teamBonusRate
                    });
                }

                // Display team members
                elements.teamMembersList.innerHTML = '';

                if (teamMembers.length === 0) {
                    elements.teamMembersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No Team Members Yet</h3>
                            <p>Share your referral code to build your team and start earning bonuses!</p>
                            <button class="btn btn-primary" onclick="switchSection('profile')">Get Referral Code</button>
                        </div>
                    `;
                } else {
                    teamMembers.forEach(member => {
                        const memberItem = document.createElement('div');
                        memberItem.className = 'team-member-item';
                        
                        const statusClass = member.status === 'active' ? '' : 'pending';
                        
                        memberItem.innerHTML = `
                            <div class="team-member-info">
                                <h4>${member.name}</h4>
                                <p>${member.email} | ${member.phone || 'No phone'}</p>
                                <p>Joined: ${new Date(member.joinedDate).toLocaleDateString()}</p>
                                <p>Total Deposits: UGX ${member.totalDeposits} | Profits: UGX ${member.totalProfits}</p>
                            </div>
                            <div class="team-member-status ${statusClass}">${member.status}</div>
                        `;
                        
                        elements.teamMembersList.appendChild(memberItem);
                    });
                }
            } catch (error) {
                console.error('Error loading team data:', error);
                showToast('Error loading team data', 'error');
            }
        }

        function updateUserUI() {
            if (!userData) return;

            // Update dashboard with current data
            document.getElementById('totalBalance').textContent = `UGX ${userData.balance || 0}`;
            document.getElementById('totalDeposits').textContent = `UGX ${userData.totalDeposits || 0}`;
            document.getElementById('totalProfits').textContent = `UGX ${userData.totalProfits || 0}`;
            
            // Get the actual count of active investments from Firestore
            db.collection('investments')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'active')
                .get()
                .then(snapshot => {
                    const activeInvestmentsCount = snapshot.size;
                    
                    // Update the active investments count in both dashboard and profile
                    document.getElementById('activeInvestments').textContent = activeInvestmentsCount;
                    document.getElementById('profileInvestments').textContent = activeInvestmentsCount;
                    
                    // Update user document with the correct count
                    db.collection('users').doc(currentUser.uid).update({
                        activeInvestments: activeInvestmentsCount
                    });
                });

            // Update profile with current data
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userEmail').textContent = userData.phone;
            document.getElementById('profileEmail').textContent = userData.email || 'Not provided';
            document.getElementById('profilePhone').textContent = userData.phone || 'Not provided';
            
            // Update account status
            let statusDisplay = 'Active';
            if (userData.status === 'suspended') {
                statusDisplay = 'Suspended';
            } else if (userData.status === 'blocked') {
                statusDisplay = 'Blocked';
            }
            document.getElementById('profileStatus').textContent = statusDisplay;
            
            document.getElementById('profileJoinedDate').textContent = userData.joinedDate ? new Date(userData.joinedDate).toLocaleDateString() : 'Not available';
            document.getElementById('profileBalance').textContent = `UGX ${userData.balance || 0}`;
            document.getElementById('profileProfits').textContent = `UGX ${userData.totalProfits || 0}`;
            document.getElementById('profileTotalDeposits').textContent = `UGX ${userData.totalDeposits || 0}`;
            document.getElementById('profileTotalWithdrawals').textContent = `UGX ${userData.totalWithdrawals || 0}`;
            
            // Update first deposit bonus status
            const bonusStatus = userData.firstDepositBonus ? 'Claimed' : 'Not yet claimed';
            document.getElementById('profileFirstDepositBonus').textContent = bonusStatus;
            
            // Update referral code and referred by
            document.getElementById('profileReferralCode').textContent = userData.referralCode || 'Not available';
            
            if (userData.referredBy) {
                // Get the name of the referrer
                db.collection('users').doc(userData.referredBy).get().then(doc => {
                    if (doc.exists) {
                        document.getElementById('profileReferredBy').textContent = doc.data().name;
                    }
                });
            } else {
                document.getElementById('profileReferredBy').textContent = 'No one';
            }
        }

        function updateUI() {
            const isLoggedIn = !!currentUser;
            elements.loginBtn.style.display = isLoggedIn ? 'none' : 'block';
            elements.signupBtn.style.display = isLoggedIn ? 'none' : 'block';

            if (!isLoggedIn) {
                // Reset all UI elements when logged out
                document.getElementById('userName').textContent = 'Guest User';
                document.getElementById('userEmail').textContent = 'Not logged in';
                document.getElementById('profileEmail').textContent = 'Not available';
                document.getElementById('profilePhone').textContent = 'Not available';
                document.getElementById('profileStatus').textContent = 'Active';
                document.getElementById('profileJoinedDate').textContent = 'Not available';
                document.getElementById('totalBalance').textContent = 'UGX 0';
                document.getElementById('totalDeposits').textContent = 'UGX 0';
                document.getElementById('totalProfits').textContent = 'UGX 0';
                document.getElementById('activeInvestments').textContent = '0';
                document.getElementById('profileBalance').textContent = 'UGX 0';
                document.getElementById('profileProfits').textContent = 'UGX 0';
                document.getElementById('profileInvestments').textContent = '0';
                document.getElementById('profileTotalDeposits').textContent = 'UGX 0';
                document.getElementById('profileTotalWithdrawals').textContent = 'UGX 0';
                document.getElementById('profileFirstDepositBonus').textContent = 'Not yet claimed';
                document.getElementById('profileReferralCode').textContent = 'Not available';
                document.getElementById('profileReferredBy').textContent = 'No one';
                
                // Clear transactions
                showEmptyTransactionState();
                // Clear investment details
                elements.investmentDetails.innerHTML = '';
                // Clear profile investments
                showEmptyProfileInvestments();
                // Clear referral data
                elements.userReferralCode.textContent = 'Loading...';
                elements.totalReferralsCount.textContent = '0';
                elements.totalReferralEarnings.textContent = 'UGX 0';
                elements.referralLink.value = '';
                elements.referralList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No Referrals Yet</h3>
                        <p>Share your referral code to start earning!</p>
                    </div>
                `;
                // Clear notifications
                elements.notificationsContent.innerHTML = `
                    <div class="empty-notifications">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No Notifications</h3>
                        <p>You don't have any notifications yet</p>
                    </div>
                `;
                updateNotificationBadges(0);
                // Clear team data
                elements.totalTeamMembers.textContent = '0';
                elements.activeTeamMembers.textContent = '0';
                elements.teamBonusRate.textContent = '0%';
                elements.totalTeamEarnings.textContent = 'UGX 0';
                elements.bonusInfo.textContent = '0+ members needed for 2% bonus';
                elements.bonusEarningsCard.style.display = 'none';
                elements.teamMembersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No Team Members Yet</h3>
                        <p>Share your referral code to build your team and start earning bonuses!</p>
                        <button class="btn btn-primary" onclick="switchSection('profile')">Get Referral Code</button>
                    </div>
                `;
            }
        }

        function showTransactionLoading() {
            elements.transactionList.innerHTML = `
                <div class="wave-loader" id="transactionLoader">
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                </div>
            `;
        }

        function showEmptyTransactionState() {
            elements.transactionList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exchange-alt"></i>
                    <h3>No Transactions Yet</h3>
                    <p>Make your first deposit to see transactions here</p>
                    <button class="btn btn-primary" onclick="switchSection('invest')">Make a Deposit</button>
                </div>
            `;
        }

        function showEmptyProfileInvestments() {
            elements.profileInvestmentsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-chart-pie"></i>
                    <h3>No Active Investments</h3>
                    <p>Start investing to see your active investments here</p>
                    <button class="btn btn-primary" onclick="switchSection('invest')">Start Investing</button>
                </div>
            `;
        }

        async function submitWithdrawal() {
            // Check if user is suspended or blocked
            if (userData && (userData.status === 'suspended' || userData.status === 'blocked')) {
                showToast('Your account is restricted. Please contact support.', 'error');
                return;
            }

            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const phone = document.getElementById('phoneNumber').value;

            if (!amount || amount < 1000) {
                showToast('Minimum withdrawal is UGX 1,000', 'warning');
                return;
            }

            if (!phone) {
                showToast('Please enter phone number', 'warning');
                return;
            }

            if (!currentUser) {
                showToast('Please log in first', 'warning');
                return;
            }

            if (!userData || userData.balance < amount) {
                showToast('Insufficient balance', 'error');
                return;
            }

            showLoading(true);

            try {
                await db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'withdrawal',
                    amount: amount,
                    phone: phone,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                
                // Show the success modal with the specific amount
                showSuccessModal(amount);
                
                // Clear the form
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('phoneNumber').value = '';
            } catch (error) {
                showToast('Error submitting withdrawal', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function createInvestment(amount, plan) {
            // Check if user is suspended or blocked
            if (userData && (userData.status === 'suspended' || userData.status === 'blocked')) {
                showToast('Your account is restricted. Please contact support.', 'error');
                return;
            }

            if (!currentUser) {
                showToast('Please log in first', 'warning');
                return;
            }

            if (!userData || userData.balance < amount) {
                showToast('Insufficient balance', 'error');
                return;
            }

            showLoading(true);

            try {
                await db.collection('investments').add({
                    userId: currentUser.uid,
                    amount: amount,
                    plan: plan,
                    status: 'active',
                    startDate: new Date().toISOString(),
                    dailyProfit: 0.05,
                    totalProfit: 0,
                    createdAt: new Date().toISOString()
                });

                await db.collection('users').doc(currentUser.uid).update({
                    balance: firebase.firestore.FieldValue.increment(-amount)
                });

                showToast(`Investment of UGX ${amount} created successfully!`, 'success');
            } catch (error) {
                showToast('Error creating investment', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadTransactions() {
            if (!currentUser) {
                showEmptyTransactionState();
                return;
            }

            try {
                const snapshot = await db.collection('transactions')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                const transactionList = document.getElementById('transactionList');
                transactionList.innerHTML = '';

                if (snapshot.empty) {
                    showEmptyTransactionState();
                    return;
                }

                snapshot.forEach(doc => {
                    const transaction = doc.data();
                    const item = document.createElement('div');
                    item.className = 'transaction-item';
                    
                    // Check if this is a bonus transaction
                    const isBonus = transaction.type === 'bonus';
                    const transactionType = isBonus ? 'bonus' : transaction.type;
                    
                    item.innerHTML = `
                        <div class="transaction-info">
                            <h4>${isBonus ? 'Bonus' : transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)} 
                                ${isBonus ? '<span class="bonus-badge">+1000 UGX</span>' : ''}
                            </h4>
                            <p>${new Date(transaction.createdAt).toLocaleDateString()}</p>
                            <span class="status ${transaction.status}">${transaction.status}</span>
                        </div>
                        <div class="transaction-amount ${transactionType}">UGX ${transaction.amount}</div>
                    `;
                    
                    transactionList.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading transactions:', error);
                showToast('Error loading transactions', 'error');
            }
        }

        function loadActiveInvestments(snapshot) {
            const investmentCount = snapshot.size;
            const investmentDetails = document.getElementById('investmentDetails');
            
            // Update the count in the card
            document.getElementById('activeInvestments').textContent = investmentCount;
            
            // Clear previous details
            investmentDetails.innerHTML = '';
            
            // If there's only one investment, show its details
            if (investmentCount === 1) {
                snapshot.forEach(doc => {
                    const investment = doc.data();
                    const planName = investment.plan.charAt(0).toUpperCase() + investment.plan.slice(1);
                    
                    investmentDetails.innerHTML = `
                        <p><span class="investment-plan">${planName} Plan</span></p>
                        <p><span class="investment-amount">UGX ${investment.amount}</span></p>
                        <p>Started: ${new Date(investment.startDate).toLocaleDateString()}</p>
                    `;
                });
            } else if (investmentCount > 1) {
                // If there are multiple investments, show a summary
                let totalAmount = 0;
                snapshot.forEach(doc => {
                    totalAmount += doc.data().amount;
                });
                
                investmentDetails.innerHTML = `
                    <p><span class="investment-amount">Total: UGX ${totalAmount}</span></p>
                    <p>${investmentCount} active investments</p>
                `;
            }
        }

        function loadProfileInvestments() {
            if (!currentUser) {
                showEmptyProfileInvestments();
                return;
            }

            db.collection('investments')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'active')
                .get()
                .then(snapshot => {
                    const investmentsList = document.getElementById('profileInvestmentsList');
                    investmentsList.innerHTML = '';

                    if (snapshot.empty) {
                        showEmptyProfileInvestments();
                        return;
                    }

                    snapshot.forEach(doc => {
                        const investment = doc.data();
                        const item = document.createElement('div');
                        item.className = 'investment-item';
                        
                        const planName = investment.plan.charAt(0).toUpperCase() + investment.plan.slice(1);
                        
                        item.innerHTML = `
                            <div class="investment-info">
                                <h4>${planName} Plan</h4>
                                <p>Started: ${new Date(investment.startDate).toLocaleDateString()}</p>
                            </div>
                            <div class="investment-amount">UGX ${investment.amount}</div>
                        `;
                        
                        investmentsList.appendChild(item);
                    });
                })
                .catch(error => {
                    console.error('Error loading profile investments:', error);
                    showToast('Error loading investments', 'error');
                });
        }

        // Load referral data
        async function loadReferralData() {
            if (!currentUser || !userData) return;

            // Update referral code
            elements.userReferralCode.textContent = userData.referralCode || 'Not available';
            
            // Update referral link
            const baseUrl = window.location.origin + window.location.pathname;
            elements.referralLink.value = `${baseUrl}?ref=${userData.referralCode}`;
            
            // Load referral stats
            const referralsSnapshot = await db.collection('referrals')
                .where('referrerId', '==', currentUser.uid)
                .get();
            
            let totalReferrals = 0;
            let totalEarnings = 0;
            let paidReferrals = 0;
            
            referralsSnapshot.forEach(doc => {
                const referral = doc.data();
                totalReferrals++;
                if (referral.status === 'paid') {
                    paidReferrals++;
                    totalEarnings += referral.bonusAmount || 500;
                }
            });
            
            elements.totalReferralsCount.textContent = totalReferrals;
            elements.totalReferralEarnings.textContent = `UGX ${totalEarnings}`;
            
            // Update user document with referral stats
            if (userData.referralCount !== totalReferrals || userData.referralEarnings !== totalEarnings) {
                await db.collection('users').doc(currentUser.uid).update({
                    referralCount: totalReferrals,
                    referralEarnings: totalEarnings
                });
            }
            
            // Load referral list
            if (totalReferrals === 0) {
                elements.referralList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No Referrals Yet</h3>
                        <p>Share your referral code to start earning!</p>
                    </div>
                `;
            } else {
                elements.referralList.innerHTML = '';
                
                // Get detailed referral information
                const referralsWithDetails = [];
                
                for (const doc of referralsSnapshot.docs) {
                    const referral = doc.data();
                    const userDoc = await db.collection('users').doc(referral.referredUserId).get();
                    
                    if (userDoc.exists) {
                        const referredUser = userDoc.data();
                        referralsWithDetails.push({
                            ...referral,
                            referredUserName: referredUser.name,
                            referredUserEmail: referredUser.email
                        });
                    }
                }
                
                // Sort by date (newest first)
                referralsWithDetails.sort((a, b) => new Date(b.referralDate) - new Date(a.referralDate));
                
                // Display referrals
                referralsWithDetails.forEach(referral => {
                    const item = document.createElement('div');
                    item.className = 'referral-item';
                    
                    item.innerHTML = `
                        <div class="referral-info">
                            <h4>${referral.referredUserName}</h4>
                            <p>${referral.referredUserEmail}</p>
                            <p>Joined: ${new Date(referral.referralDate).toLocaleDateString()}</p>
                        </div>
                        <div class="referral-status ${referral.status}">${referral.status}</div>
                    `;
                    
                    elements.referralList.appendChild(item);
                });
            }
        }

        async function copyReferralLink() {
            try {
                await navigator.clipboard.writeText(elements.referralLink.value);
                showToast('Referral link copied!', 'success');
            } catch (error) {
                showToast('Failed to copy', 'error');
            }
        }

        async function handleLogout() {
            try {
                cleanupListeners();
                await auth.signOut();
                hideAccountStatusMessages();
                enableUserActions();
                showToast('Logged out successfully', 'success');
            } catch (error) {
                showToast('Error logging out', 'error');
            }
        }

        function openSocialLink(url) {
            window.open(url, '_blank');
        }

        function showToast(message, type) {
            elements.toast.textContent = message;
            elements.toast.className = `toast ${type} show`;
            setTimeout(() => elements.toast.classList.remove('show'), 3000);
        }

        function showLoading(show) {
            elements.loading.classList.toggle('show', show);
        }

        // Check for referral code in URL parameters
        function checkUrlForReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            
            if (refCode && !currentUser) {
                // Store the referral code in sessionStorage to use during signup
                sessionStorage.setItem('referralCode', refCode);
                showToast(`You've been invited with referral code: ${refCode}`, 'success');
            }
        }

        // Initialize referral code from URL if present
        window.addEventListener('DOMContentLoaded', () => {
            checkUrlForReferral();
            
            // If there's a referral code in sessionStorage, pre-fill the signup form
            const savedRefCode = sessionStorage.getItem('referralCode');
            if (savedRefCode && elements.referralCode) {
                elements.referralCode.value = savedRefCode;
                checkReferralCode();
            }
        });

        let isLoginMode = true;
    </script>
</body>
</html>